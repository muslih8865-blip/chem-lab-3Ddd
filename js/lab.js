// lab.js - simplified 3D lab logic\nconst MATERIALS = [\n  { id:'HCl', name:'HCl', color:'#fef08a' },\n  { id:'NaOH', name:'NaOH', color:'#a7f3d0' },\n  { id:'CuSO4', name:'CuSO4', color:'#60a5fa' },\n  { id:'Zn', name:'Zn', color:'#cbd5e1' },\n  { id:'H2O2', name:'H2O2', color:'#fda4af' },\n  { id:'MnO2', name:'MnO2', color:'#94a3b8' }\n];\nconst REACTIONS = [\n  { name:'حمض + معدن → تصاعد غاز', requires:['HCl','Zn'], result:{effect:'bubbles', color:'#fff2cc', info:'تفاعل حمض + معدن.'}, points:10 },\n  { name:'حمض + قاعدة → ملح + ماء', requires:['HCl','NaOH'], result:{effect:'colorChange', color:'#c7f9e4', info:'تفاعل التعادل.'}, points:8 },\n  { name:'بيروكسيد + محفز → رغوة', requires:['H2O2','MnO2'], result:{effect:'foam', color:'#ffffff', info:'تحلل H2O2.'}, points:15 },\n];\nconst materialsDiv = document.getElementById('materials');\nconst logDiv = document.getElementById('log');\nconst infoDiv = document.getElementById('info');\nconst mixBtn = document.getElementById('mixBtn');\nconst emptyBtn = document.getElementById('emptyBtn');\nconst toggle3DBtn = document.getElementById('toggle3D');\nconst resetScoreBtn = document.getElementById('resetScore');\nlet score = parseInt(localStorage.getItem('chem_score')||'0',10);\nlet enable3D = (localStorage.getItem('chem_3d') || 'true') === 'true';\ntoggle3DBtn.textContent = enable3D ? 'تعطيل 3D' : 'تفعيل 3D';\ndocument.getElementById('info').innerText = 'اسحب المواد إلى الأنابيب ثم اضغط "اخلط!"';\n// create material cards\nMATERIALS.forEach(mat=>{\n  const el = document.createElement('div'); el.className='chem'; el.draggable=true; el.dataset.id=mat.id; el.innerHTML = '<div class="swatch" style="background:'+mat.color+'">'+mat.id+'</div><div style="font-size:13px;color:var(--muted);margin-inline-start:6px">'+mat.name+'</div>'; el.addEventListener('dragstart', e=> e.dataTransfer.setData('text/plain', mat.id)); materialsDiv.appendChild(el);\n});\nconst tubes = {}; const tubeScenes={};\ndocument.querySelectorAll('.dropzone').forEach(z=>{ tubes[z.dataset.tube]=[]; const canvasWrap=document.createElement('div'); canvasWrap.className='tube-canvas'; canvasWrap.style.position='absolute'; canvasWrap.style.inset='12px 12px 48px 12px'; canvasWrap.style.pointerEvents='none'; z.appendChild(canvasWrap); tubeScenes[z.dataset.tube]={container:canvasWrap,active:false,particles:[]}; });\ndocument.querySelectorAll('.dropzone').forEach(zone=>{ zone.addEventListener('dragover', e=>{ e.preventDefault(); zone.style.outline='2px dashed rgba(96,165,250,0.5)'; }); zone.addEventListener('dragleave', e=>{ zone.style.outline='none'; }); zone.addEventListener('drop', e=>{ e.preventDefault(); zone.style.outline='none'; const id = e.dataTransfer.getData('text/plain'); if(!id) return; const tid = zone.dataset.tube; addMaterialToTube(tid,id); }); });\nfunction addMaterialToTube(tid, mid){ if(!tubes[tid]) tubes[tid]=[]; if(tubes[tid].length>=3){ pushLog('الأنبوب '+tid+' ممتلئ'); return; } tubes[tid].push(mid); updateTubeVisual(tid); pushLog('أضفت '+mid+' إلى أنبوب '+tid); }\nfunction updateTubeVisual(tid){ const zone=document.querySelector('.dropzone[data-tube="'+tid+'"]'); const contents=zone.parentElement.querySelector('.contents'); const liq=zone.querySelector('.liquid'); const items=tubes[tid]||[]; contents.textContent = items.length? items.join(' + '): 'فارغ'; const height = Math.min(88, items.length*30); liq.style.height = height + '%'; if(items.length===0){ liq.style.background='transparent'; } else { const cols = items.map(id=> (MATERIALS.find(m=>m.id===id)||{}).color || '#fff'); liq.style.background = blendColors(cols); } if(enable3D) ensureTubeScene(tid); if(enable3D && tubeScenes[tid].scene){ const itemsCols = items.length? items.map(id=> (MATERIALS.find(m=>m.id===id)||{}).color||'#ffffff') : ['#000000']; const rgb = hexToRgb(itemsCols[0]); if(tubeScenes[tid].tintLight) tubeScenes[tid].tintLight.color.setRGB(rgb.r/255, rgb.g/255, rgb.b/255); } }\nfunction findReaction(items){ const s = new Set(items); for(const rx of REACTIONS){ if(rx.requires.every(x=> s.has(x))) return rx; } return null; }\nmixBtn.addEventListener('click', ()=>{ let any=false; document.getElementById('log').innerHTML=''; Object.keys(tubes).forEach(tid=>{ const items=tubes[tid]; if(items && items.length>0){ any=true; const rx=findReaction(items); if(rx){ applyReaction(tid,rx); } else { pushQuick('أنبوب '+tid+': لا يحدث تفاعل ملحوظ.'); pushLog('أنبوب '+tid+': خليط '+items.join(' + ')+' — لا تفاعل.'); visualPulse(tid); } } }); if(!any) pushLog('لا توجد مواد للخلط.'); });\nfunction applyReaction(tid,reaction){ const pts = reaction.points||5; pushQuick('أنبوب '+tid+': '+reaction.name+' → +'+pts+' نقاط'); pushLog('تفاعل في أنبوب '+tid+': '+reaction.name+' — '+(reaction.result.info||'')); score += pts; localStorage.setItem('chem_score', score); if(enable3D){ if(reaction.result.effect==='bubbles') spawnBubbles3D(tid); else if(reaction.result.effect==='foam') spawnFoam3D(tid); else colorFlash3D(tid,reaction.result.color); } visualPulse(tid,reaction.result.color); tubes[tid]=[]; setTimeout(()=> updateTubeVisual(tid),700); infoDiv.innerHTML = '<strong>نتيجة:</strong> '+reaction.name+'<br>'+ (reaction.result.info||''); }\nemptyBtn.addEventListener('click', ()=>{ Object.keys(tubes).forEach(k=> tubes[k]=[]); Object.keys(tubes).forEach(k=> updateTubeVisual(k)); pushLog('تم تفريغ الأنابيب.'); });\n// small helpers\nfunction pushLog(txt){ const el=document.createElement('div'); el.textContent = new Date().toLocaleTimeString('ar-EG') + ' — ' + txt; logDiv.prepend(el); }\nfunction pushQuick(txt){ const el=document.createElement('div'); el.textContent = new Date().toLocaleTimeString('ar-EG') + ' — ' + txt; document.getElementById('log').prepend(el); }\nfunction blendColors(colors){ if(colors.length===1) return colors[0]; const rgbs=colors.map(hexToRgb); const avg=rgbs.reduce((a,c)=>{a.r+=c.r;a.g+=c.g;a.b+=c.b;return a},{r:0,g:0,b:0}); avg.r=Math.round(avg.r/rgbs.length);avg.g=Math.round(avg.g/rgbs.length);avg.b=Math.round(avg.b/rgbs.length); return 'rgb('+avg.r+','+avg.g+','+avg.b+')'; }\nfunction hexToRgb(hex){ hex=hex.replace('#',''); if(hex.length===3) hex=hex.split('').map(c=>c+c).join(''); const num=parseInt(hex,16); return {r:(num>>16)&255,g:(num>>8)&255,b:num&255}; }\n// minimal three.js mini-scene functions (will create canvas per tube)\nfunction ensureTubeScene(tid){ const ts = tubeScenes[tid]; if(ts.active) return; const w = ts.container.clientWidth || 220; const h = ts.container.clientHeight || 120; const renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true }); renderer.setSize(w,h); renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)); ts.container.appendChild(renderer.domElement); const scene = new THREE.Scene(); const camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 50); camera.position.set(0,1.2,3); const ambient = new THREE.AmbientLight(0x223344,0.9); scene.add(ambient); const tint = new THREE.PointLight(0x66bbff,0.6,8); tint.position.set(0,1.2,1.5); scene.add(tint); const cylGeo = new THREE.CylinderGeometry(0.9,0.9,1.6,24,1,true); const cylMat = new THREE.MeshPhysicalMaterial({ color:0x001122, transparent:true, opacity:0.06, roughness:0.1 }); const cylinder = new THREE.Mesh(cylGeo,cylMat); cylinder.rotation.x = Math.PI/2; scene.add(cylinder); const planeGeo = new THREE.CircleGeometry(0.7,32); const planeMat = new THREE.MeshStandardMaterial({ color:0x004466, transparent:true, opacity:0.7, roughness:0.4 }); const liquidPlane = new THREE.Mesh(planeGeo,planeMat); liquidPlane.rotation.x = -Math.PI/2; liquidPlane.position.z = -0.2; liquidPlane.position.y = -0.4; scene.add(liquidPlane); ts.renderer=renderer; ts.scene=scene; ts.camera=camera; ts.liquid=liquidPlane; ts.tintLight=tint; ts.active=true; ts.particles=[]; ts.lastTime=performance.now(); ts.animate=function(now){ const dt=(now-(ts.lastTime||now))/1000; ts.lastTime=now; for(let i=ts.particles.length-1;i>=0;i--){ const p=ts.particles[i]; p.userData.vy += -9.8*dt*0.02; p.position.y += p.userData.vy * dt * 1.8; p.material.opacity -= dt*0.6; if(p.material.opacity<=0){ ts.scene.remove(p); ts.particles.splice(i,1); } } ts.renderer.render(ts.scene, ts.camera); }; function loop(t){ if(!ts.active) return; ts.animate(t); ts.raf = requestAnimationFrame(loop); } ts.raf = requestAnimationFrame(loop); window.addEventListener('resize', ()=>{ const w2 = ts.container.clientWidth || 220; const h2 = ts.container.clientHeight || 120; renderer.setSize(w2,h2); ts.camera.aspect = w2/h2; ts.camera.updateProjectionMatrix(); }); }\nfunction spawnBubbles3D(tid){ const ts = tubeScenes[tid]; if(!ts.active) ensureTubeScene(tid); const scene = ts.scene; for(let i=0;i<12;i++){ const g=new THREE.SphereGeometry(0.05+Math.random()*0.06,8,6); const m=new THREE.MeshStandardMaterial({ color:0xffffff, transparent:true, opacity:0.95, roughness:0.1 }); const s=new THREE.Mesh(g,m); s.position.set((Math.random()-0.5)*0.6, -0.5+Math.random()*0.3, (Math.random()-0.5)*0.2); s.userData={vy:0.5+Math.random()*0.6}; scene.add(s); ts.particles.push(s); } }\nfunction spawnFoam3D(tid){ const ts = tubeScenes[tid]; if(!ts.active) ensureTubeScene(tid); const scene = ts.scene; for(let i=0;i<20;i++){ const g=new THREE.SphereGeometry(0.04+Math.random()*0.06,8,6); const m=new THREE.MeshStandardMaterial({ color:0xffffff, transparent:true, opacity:0.95, roughness:0.8 }); const s=new THREE.Mesh(g,m); s.position.set((Math.random()-0.5)*0.6, -0.5+Math.random()*0.4, (Math.random()-0.5)*0.2); s.userData={vy:0.2+Math.random()*0.4}; scene.add(s); ts.particles.push(s); } }\nfunction colorFlash3D(tid, hex){ const ts = tubeScenes[tid]; if(!ts.active) ensureTubeScene(tid); const c = hexToRgb(hex||'#ffffff'); if(ts.tintLight){ ts.tintLight.color.setRGB(c.r/255,c.g/255,c.b/255); setTimeout(()=> ts.tintLight.color.setRGB(0.4,0.6,0.9),900); } }\n// initialize scenes if enabled\nif(enable3D){ Object.keys(tubeScenes).forEach(t=> ensureTubeScene(t)); } else { Object.keys(tubeScenes).forEach(t=> tubeScenes[t].container.classList.add('disabled')); }\n// reset score handler\nresetScoreBtn.addEventListener('click', ()=>{ score=0; localStorage.setItem('chem_score', score); pushLog('تم إعادة تعيين النقاط.'); });\npushLog('مختبر جاهز. اسحب المواد ثم اضغط اخلط!');